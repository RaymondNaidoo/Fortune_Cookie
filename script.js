/* Large fortunes list omitted here for brevity. Keep your existing list or paste it below. */
const fortunes = [
/* 200 UNIQUE Short, Witty, Thought-Provoking Fortunes */
const fortunes = [
  "A closed mouth gathers no feet.",
  "A friend is a gift you give yourself.",
  "A journey of a thousand miles begins with a single step.",
  "A smooth sea never made a skilled sailor.",
  "Act as if what you do makes a difference. It does.",
  "An inch of time is an inch of gold.",
  "Be the change you wish to see in the world.",
  "Believe it can be done.",
  "Small steps lead to giant leaps.",
  "Your smile is your best accessory.",
  "Kindness costs nothing but buys everything.",
  "The best way out is always through.",
  "Dreams don't work unless you do.",
  "What you seek is seeking you.",
  "Every moment is a fresh beginning.",
  "Your only limit is your mind.",
  "Plant today, harvest tomorrow.",
  "The obstacle is the way.",
  "Good things come to those who create.",
  "Listen twice, speak once.",
  "Your vibe attracts your tribe.",
  "Progress, not perfection.",
  "The magic is in the mess.",
  "You are enough.",
  "Create the life you love.",
  "Bloom where you're planted.",
  "Your story isn't over yet.",
  "Courage starts with showing up.",
  "The best view comes after the hardest climb.",
  "You become what you believe.",
  "Small acts, big impact.",
  "Your heart knows the way.",
  "Dance like nobody's watching.",
  "The future belongs to the bold.",
  "Gratitude turns what we have into enough.",
  "You are the author of your story.",
  "Risk it for the biscuit.",
  "Stars can't shine without darkness.",
  "Your next chapter is the best yet.",
  "Kindness is free, sprinkle it.",
  "The best is yet to come.",
  "You make the world brighter.",
  "Fear is just excitement in disguise.",
  "Your potential is limitless.",
  "Create more than you consume.",
  "The journey shapes the destination.",
  "You are stronger than you know.",
  "Good energy attracts good vibes.",
  "Every day is a new page.",
  "Your light illuminates others.",
  "Trust the timing of your life.",
  "Bold beginnings, beautiful endings.",
  "You are a masterpiece in progress.",
  "Small wins build big victories.",
  "Your presence is a present.",
  "The best revenge is massive success.",
  "You attract what you are.",
  "Magic happens outside comfort zones.",
  "Your voice matters.",
  "Plant kindness, harvest peace.",
  "You are the calm in chaos.",
  "Dream big, work hard.",
  "Your scars are your strength.",
  "Good things take time.",
  "You are a walking miracle.",
  "Shine bright like a diamond.",
  "Your energy speaks louder than words.",
  "The comeback is always stronger.",
  "You are capable of amazing things.",
  "Create your own sunshine.",
  "Your heart is your compass.",
  "Bold moves build legends.",
  "You are unstoppable.",
  "Gratitude changes everything.",
  "Your story inspires others.",
  "Small seeds grow mighty trees.",
  "You light up the room.",
  "The best is yet to bloom.",
  "Your courage inspires others.",
  "You are a force of nature.",
  "Good vibes only.",
  "Your dreams are calling.",
  "You make ordinary moments magical.",
  "The universe conspires to help you.",
  "Your smile changes the world.",
  "You are exactly where you need to be.",
  "Big magic happens in small moments.",
  "Your potential knows no bounds.",
  "You are a gift to this world.",
  "Create the life of your dreams.",
  "Your heart leads you home.",
  "You are braver than you believe.",
  "Good things are coming.",
  "Your light never fades.",
  "You are the spark others need.",
  "Dreams plus action equals miracles.",
  "Your kindness ripples outward.",
  "You are a living legend.",
  "The best chapters are unwritten.",
  "Your energy creates your reality.",
  "You bloom through adversity.",
  "Good fortune follows good hearts.",
  "Your presence heals.",
  "You are destined for greatness.",
  "Small steps, epic journeys.",
  "Your smile is contagious.",
  "You are the hero of your story.",
  "Magic is in the making.",
  "Your courage changes everything.",
  "You attract abundance.",
  "The best is yet to unfold.",
  "Your light guides others.",
  "You are pure possibility.",
  "Good things multiply.",
  "Your heart knows the truth.",
  "You create your own luck.",
  "Bold hearts win.",
  "Your story matters.",
  "You are a rare gem.",
  "Dream without limits.",
  "Your kindness builds bridges.",
  "You are unstoppable force.",
  "Good energy equals good life.",
  "Your future shines bright.",
  "You inspire greatness.",
  "Create joy daily.",
  "Your soul sparkles.",
  "You are enough, always.",
  "Big dreams, bigger reality.",
  "Your light transforms.",
  "Good fortune finds you.",
  "You are magic itself.",
  "Small acts change worlds.",
  "Your heart is golden.",
  "You manifest miracles.",
  "Bold steps lead home.",
  "Your smile heals.",
  "You are infinite potential.",
  "Good vibes create reality.",
  "Your destiny awaits.",
  "You light the path.",
  "Create without fear.",
  "Your energy radiates.",
  "You are a blessing.",
  "Dreams become destiny.",
  "Your kindness endures.",
  "You shine from within.",
  "Good things chase you.",
  "Your courage soars.",
  "You are pure light.",
  "Big magic, small steps.",
  "Your heart guides true.",
  "You create wonders.",
  "Good fortune flows.",
  "Your story inspires.",
  "You are limitless love.",
  "Bold hearts conquer.",
  "Your light eternal.",
  "You manifest magic.",
  "Small wins, big life.",
  "Your soul sings.",
  "Good energy forever.",
  "You are the dream.",
  "Create your miracle.",
  "Your kindness eternal.",
  "You shine brightest.",
  "Destiny calls your name.",
  "Your heart unstoppable.",
  "You are the magic.",
  "Good fortune yours.",
  "Your light forever.",
  "Bold and beautiful.",
  "You create destiny.",
  "Your smile eternal.",
  "Infinite possibilities await.",
  "Your courage legendary.",
  "You are the light.",
  "Good things multiply.",
  "Your heart boundless.",
  "You manifest wonders.",
  "Shine on forever.",
  "Your story epic.",
  "You are pure gold.",
  "Dreams made real.",
  "Your kindness legendary.",
  "You light eternity.",
  "Good fortune eternal.",
  "Your soul radiant.",
  "Bold forever.",
  "You create legends.",
  "Your magic endless.",
  "Infinite you await.",
  "Your light immortal.",
  "Good vibes eternal.",
  "You are destiny.",
  "Heart of gold shines.",
  "You manifest eternity.",
  "Your courage infinite.",
  "Shine eternal light.",
  "Your story legendary.",
  "Pure magic you.",
  "Good fortune forever.",
  "Your heart eternal.",
  "You create infinity.",
  "Bold soul shines.",
  "Your light boundless.",
  "Dreams eternal now.",
  "Kindness forever yours.",
  "You are legend.",
  "Good energy infinite.",
  "Your magic eternal.",
  "Shine bright always.",
  "Your destiny golden.",
  "You light forever.",
  "Heart creates magic.",
  "Bold and eternal.",
  "Your soul shines.",
  "Good fortune flows.",
  "You are infinity.",
  "Create eternal joy.",
  "Your light radiant.",
  "Dreams manifest now.",
  "Kindness builds eternity.",
  "You shine legendary.",
  "Good vibes forever.",
  "Your heart golden.",
  "Bold creates destiny.",
  "Your magic infinite.",
  "Shine eternal you.",
  "Your story shines.",
  "Pure light eternal.",
  "Good fortune yours.",
  "You create wonders.",
  "Heart beats magic.",
  "Your courage shines.",
  "Infinite light you.",
  "Bold soul eternal.",
  "Your destiny radiant.",
  "Good energy flows.",
  "You are the shine.",
  "Create infinite joy.",
  "Your light forever.",
  "Dreams golden now.",
  "Kindness eternal light.",
  "You manifest legend.",
  "Good vibes infinite.",
  "Your heart shines.",
  "Bold and radiant.",
  "Your magic golden.",
  "Shine forever bright.",
  "Your soul eternal.",
  "Good fortune radiant.",
  "You light infinity.",
  "Create golden destiny.",
  "Your courage eternal.",
  "Infinite magic you.",
  "Bold heart shines.",
  "Your story golden.",
  "Pure light infinite.",
  "Good energy eternal.",
  "You are radiant.",
  "Heart creates eternity.",
  "Your light golden.",
  "Dreams shine forever.",
  "Kindness builds light.",
  "You manifest infinity.",
  "Good vibes golden.",
  "Your soul radiant.",
  "Bold creates light.",
  "Your magic eternal.",
  "Shine infinite bright.",
  "Your destiny shines.",
  "Good fortune infinite.",
  "You light eternal.",
  "Create radiant joy.",
  "Your heart infinite.",
  "Bold soul golden.",
  "Your courage radiant.",
  "Infinite light shines.",
  "Your story eternal.",
  "Pure magic golden.",
  "Good energy radiant.",
  "You are infinite.",
  "Heart shines eternal.",
  "Your light infinite.",
  "Dreams create gold.",
  "Kindness radiant light.",
  "You manifest eternal.",
  "Good vibes infinite.",
  "Your soul golden.",
  "Bold and shining.",
  "Your magic radiant.",
  "Shine golden eternal.",
  "Your destiny infinite.",
  "Good fortune golden.",
  "You light radiant.",
  "Create eternal shine.",
  "Your heart golden.",
  "Bold creates infinity.",
  "Your courage shines.",
  "Infinite golden light.",
  "Your story radiant.",
  "Pure light eternal.",
  "Good energy golden.",
  "You are the gold.",
  "Heart manifests light.",
  "Your light eternal.",
  "Dreams golden infinite.",
  "Kindness shines forever.",
  "You create radiant.",
  "Good vibes eternal.",
  "Your soul infinite.",
  "Bold heart golden.",
  "Your magic shines.",
  "Shine infinite gold.",
  "Your destiny radiant.",
  "Good fortune eternal.",
  "You light golden.",
  "Create infinite light.",
  "Your heart radiant.",
  "Bold soul shines.",
  "Your courage infinite.",
  "Golden light eternal.",
  "Your story golden.",
  "Pure magic radiant.",
  "Good energy infinite.",
  "You shine eternal.",
  "Heart creates golden.",
  "Your light radiant.",
  "Dreams shine infinite.",
  "Kindness golden light.",
  "You manifest gold.",
  "Good vibes radiant.",
  "Your soul shines.",
  "Bold creates eternal.",
  "Your magic golden.",
  "Shine radiant forever.",
  "Your destiny golden.",
  "Good fortune shines.",
  "You light infinite.",
  "Create golden light.",
  "Your heart eternal.",
  "Bold and radiant.",
  "Your courage golden.",
  "Infinite shine you.",
  "Your story infinite.",
  "Pure light golden.",
  "Good energy radiant.",
  "You are golden.",
  "Heart shines infinite.",
  "Your light eternal.",
  "Dreams create radiant.",
  "Kindness eternal gold.",
  "You manifest shine.",
  "Good vibes golden.",
  "Your soul radiant.",
  "Bold heart infinite.",
  "Your magic shines.",
  "Shine golden light.",
  "Your destiny eternal.",
  "Good fortune radiant.",
  "You light golden.",
  "Create radiant shine.",
  "Your heart infinite.",
  "Bold soul golden.",
  "Your courage radiant.",
  "Infinite golden shine.",
  "Your story shines.",
  "Pure magic eternal.",
  "Good energy golden.",
  "You shine radiant.",
  "Heart creates infinite.",
  "Your light golden.",
  "Dreams radiant forever.",
  "Kindness shines gold.",
  "You manifest eternal.",
  "Good vibes infinite.",
  "Your soul golden.",
  "Bold creates radiant.",
  "Your magic infinite.",
  "Shine eternal gold.",
  "Your destiny shines.",
  "Good fortune golden.",
  "You light radiant.",
  "Create infinite gold.",
  "Your heart shines.",
  "Bold and golden.",
  "Your courage eternal.",
  "Golden light infinite.",
  "Your story radiant.",
  "Pure shine eternal.",
  "Good energy shines.",
  "You are infinite.",
  "Heart golden radiant.",
  "Your light infinite.",
  "Dreams create golden.",
  "Kindness radiant gold.",
  "You manifest light.",
  "Good vibes eternal.",
  "Your soul shines.",
  "Bold heart golden.",
  "Your magic radiant.",
  "Shine infinite light.",
  "Your destiny golden.",
  "Good fortune infinite.",
  "You light eternal.",
  "Create golden shine.",
  "Your heart radiant.",
  "Bold soul infinite.",
  "Your courage golden.",
  "Infinite radiant light.",
  "Your story eternal.",
  "Pure magic golden.",
  "Good energy radiant.",
  "You shine infinite.",
  "Heart creates golden.",
  "Your light radiant.",
  "Dreams shine eternal.",
  "Kindness golden shine.",
  "You manifest radiant.",
  "Good vibes golden.",
  "Your soul infinite.",
  "Bold creates light.",
  "Your magic eternal.",
  "Shine golden radiant.",
  "Your destiny infinite.",
  "Good fortune shines.",
  "You light golden.",
  "Create eternal light.",
  "Your heart golden.",
  "Bold and radiant.",
  "Your courage infinite.",
  "Golden infinite shine.",
  "Your story golden.",
  "Pure light radiant.",
  "Good energy eternal.",
  "You are radiant.",
  "Heart shines golden.",
  "Your light eternal.",
  "Dreams golden radiant.",
  "Kindness infinite light.",
  "You manifest golden.",
  "Good vibes radiant.",
  "Your soul golden.",
  "Bold heart shines.",
  "Your magic infinite.",
  "Shine eternal radiant.",
  "Your destiny golden.",
  "Good fortune eternal.",
  "You light infinite.",
  "Create radiant gold.",
  "Your heart eternal.",
  "Bold soul radiant.",
  "Your courage golden.",
  "Infinite light golden.",
  "Your story shines.",
  "Pure magic infinite.",
  "Good energy golden.",
  "You shine eternal.",
  "Heart creates radiant.",
  "Your light golden.",
  "Dreams eternal shine.",
  "Kindness golden radiant.",
  "You manifest infinite.",
  "Good vibes eternal.",
  "Your soul radiant.",
  "Bold creates golden.",
  "Your magic shines.",
  "Shine infinite golden.",
  "Your destiny radiant.",
  "Good fortune golden.",
  "You light eternal.",
  "Create golden infinite.",
  "Your heart shines.",
  "Bold and golden.",
  "Your courage radiant.",
  "Golden shine infinite.",
  "Your story infinite.",
  "Pure light eternal.",
  "Good energy radiant.",
  "You are golden.",
  "Heart infinite golden.",
  "Your light radiant.",
  "Dreams create eternal.",
  "Kindness shines infinite.",
  "You manifest radiant.",
  "Good vibes golden.",
  "Your soul eternal.",
  "Bold heart radiant.",
  "Your magic golden.",
  "Shine golden eternal.",
  "Your destiny shines.",
  "Good fortune infinite.",
  "You light golden.",
  "Create eternal radiant.",
  "Your heart infinite.",
  "Bold soul golden.",
  "Your courage eternal.",
  "Infinite golden light.",
  "Your story radiant.",
  "Pure shine infinite.",
  "Good energy eternal.",
  "You shine golden.",
  "Heart creates infinite.",
  "Your light eternal.",
  "Dreams golden eternal.",
  "Kindness radiant shine.",
  "You manifest golden.",
  "Good vibes infinite.",
  "Your soul golden.",
  "Bold creates radiant.",
  "Your magic eternal.",
  "Shine radiant golden.",
  "Your destiny infinite.",
  "Good fortune radiant.",
  "You light shines.",
  "Create infinite golden.",
  "Your heart radiant.",
  "Bold and eternal.",
  "Your courage golden.",
  "Golden light radiant.",
  "Your story eternal.",
  "Pure magic golden.",
  "Good energy infinite.",
  "You are eternal.",
  "Heart shines radiant.",
  "Your light golden.",
  "Dreams infinite shine.",
  "Kindness eternal golden.",
  "You manifest eternal.",
  "Good vibes radiant.",
  "Your soul infinite.",
  "Bold heart golden.",
  "Your magic radiant.",
  "Shine eternal light.",
  "Your destiny golden.",
  "Good fortune eternal.",
  "You light infinite.",
  "Create golden radiant.",
  "Your heart eternal.",
  "Bold soul shines.",
  "Your courage infinite.",
  "Infinite golden radiant.",
  "Your story golden.",
  "Pure light eternal.",
  "Good energy golden.",
  "You shine radiant.",
  "Heart creates golden.",
  "Your light infinite.",
  "Dreams shine golden.",
  "Kindness infinite gold.",
  "You manifest shine.",
  "Good vibes eternal.",
  "Your soul radiant.",
  "Bold creates infinite.",
  "Your magic golden.",
  "Shine golden infinite.",
  // ... include the full list you provided earlier ...
  "Your destiny awaits—go claim it!"
];

const $ = (sel) => document.querySelector(sel);

const cookie = $("#cookie");
const paper = $("#fortune-paper");
const textEl = $("#fortune-text");
const crackBtn = $("#crack-btn");
const redoBtn = $("#redo-btn");
const liveRegion = $("#live-region");
const confettiCanvas = $("#confetti-canvas");
const ctx = confettiCanvas.getContext("2d", { alpha: true });

let isAnimating = false;

const confettiPieces = [];
function spawnConfettiBurst(centerX, centerY, count = 120) {
  for (let i = 0; i < count; i++) {
    const angle = Math.random() * Math.PI * 2;
    const speed = 3 + Math.random() * 5;
    confettiPieces.push({
      x: centerX, y: centerY,
      vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed - 2,
      size: 2 + Math.random() * 5,
      rot: Math.random() * Math.PI, vr: (Math.random() - 0.5) * 0.3,
      color: randomConfettiColor(), life: 90 + Math.random() * 60
    });
  }
}
function randomConfettiColor() {
  const palette = ["#7aa2ff", "#ff7ad9", "#ffd86b", "#8ef6a0", "#f6c66e", "#c99e44", "#e7ebff"];
  return palette[Math.floor(Math.random() * palette.length)];
}
function resizeCanvas() {
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  confettiCanvas.width = Math.floor(window.innerWidth * dpr);
  confettiCanvas.height = Math.floor(window.innerHeight * dpr);
  confettiCanvas.style.width = window.innerWidth + "px";
  confettiCanvas.style.height = window.innerHeight + "px";
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}
function tickConfetti() {
  ctx.clearRect(0, 0, confettiCanvas.width, confettiCanvas.height);
  for (let i = confettiPieces.length - 1; i >= 0; i--) {
    const p = confettiPieces[i];
    p.vy += 0.08; p.vx *= 0.995; p.vy *= 0.995;
    p.x += p.vx; p.y += p.vy; p.rot += p.vr; p.life -= 1;
    if (p.life <= 0 || p.y > window.innerHeight + 40) { confettiPieces.splice(i, 1); continue; }
    ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.rot);
    ctx.fillStyle = p.color; ctx.globalAlpha = Math.max(0, p.life / 120);
    const w = p.size * (0.8 + Math.abs(Math.sin(p.rot)) * 0.6); const h = p.size;
    ctx.fillRect(-w / 2, -h / 2, w, h); ctx.restore();
  }
  requestAnimationFrame(tickConfetti);
}

/* Off-screen measurer to get accurate width on mobile */
let measurer;
function ensureMeasurer() {
  if (measurer) return measurer;
  measurer = document.createElement("span");
  measurer.style.position = "absolute";
  measurer.style.visibility = "hidden";
  measurer.style.whiteSpace = "nowrap";
  measurer.style.pointerEvents = "none";
  // Mirror .fortune-text font styles for accuracy
  const cs = getComputedStyle(textEl);
  measurer.style.fontFamily = cs.fontFamily;
  measurer.style.fontSize = cs.fontSize;
  measurer.style.fontWeight = cs.fontWeight;
  measurer.style.letterSpacing = cs.letterSpacing;
  document.body.appendChild(measurer);
  return measurer;
}

function clampPaperWidth(px) {
  const cap = Math.max(0, window.innerWidth - 24); // matches CSS max-width clamp
  return Math.min(px, cap);
}

function syncPaperWidth() {
  const m = ensureMeasurer();
  m.textContent = textEl.textContent;
  const measured = m.getBoundingClientRect().width;
  const cs = getComputedStyle(paper);
  const pad = parseFloat(cs.paddingLeft) + parseFloat(cs.paddingRight);
  const target = Math.ceil(measured + pad);
  paper.style.width = clampPaperWidth(target) + "px";
}

async function typeText(text) {
  textEl.textContent = "";
  paper.style.width = "32px";
  document.body.classList.add("typing");
  for (let i = 0; i <= text.length; i++) {
    textEl.textContent = text.slice(0, i);
    syncPaperWidth();
    await wait(18 + Math.random() * 24);
  }
  document.body.classList.remove("typing");
}

function wait(ms) { return new Promise((res) => setTimeout(res, ms)); }
function pickFortune() { return fortunes[Math.floor(Math.random() * fortunes.length)]; }

function resetCookie() {
  cookie.classList.remove("cracked");
  paper.style.opacity = "0";
  textEl.textContent = "";
  paper.setAttribute("aria-hidden", "true");
  paper.style.width = "32px";
  liveRegion.textContent = "";
  redoBtn.hidden = true;
  crackBtn.disabled = false;
}

async function crackCookie() {
  if (isAnimating) return;
  isAnimating = true;

  cookie.classList.remove("cracked");
  paper.style.opacity = "0";
  textEl.textContent = "";
  paper.style.width = "32px";

  await wait(40);
  cookie.classList.add("cracked");

  const rect = cookie.getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height * 0.45;
  spawnConfettiBurst(cx, cy, 160);

  await wait(300);
  const fortune = pickFortune();
  paper.setAttribute("aria-hidden", "false");
  await typeText(fortune);
  liveRegion.textContent = "Fortune: " + fortune;

  redoBtn.hidden = false;
  crackBtn.disabled = true;

  await wait(600);
  isAnimating = false;
}

function setup() {
  ensureMeasurer();
  resizeCanvas();
  window.addEventListener("resize", () => { resizeCanvas(); syncPaperWidth(); }, { passive: true });
  requestAnimationFrame(tickConfetti);

  crackBtn.addEventListener("click", crackCookie);
  crackBtn.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") { e.preventDefault(); crackCookie(); }
  });

  redoBtn.addEventListener("click", async () => {
    resetCookie();
    await wait(150);
    crackCookie();
  });
}

document.addEventListener("DOMContentLoaded", setup);

